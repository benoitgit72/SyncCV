<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Réinitialiser le mot de passe - SyncCV Admin</title>
    <link rel="stylesheet" href="css/admin-styles.css">
</head>
<body class="login-page">
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>SyncCV</h1>
                <p>Réinitialisation du mot de passe</p>
            </div>

            <form id="resetPasswordForm" class="login-form">
                <div class="form-group">
                    <label for="newPassword">Nouveau mot de passe</label>
                    <input
                        type="password"
                        id="newPassword"
                        name="newPassword"
                        placeholder="••••••••"
                        required
                        minlength="6"
                        autocomplete="new-password"
                    >
                    <small class="help-text">Minimum 6 caractères</small>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmer le mot de passe</label>
                    <input
                        type="password"
                        id="confirmPassword"
                        name="confirmPassword"
                        placeholder="••••••••"
                        required
                        minlength="6"
                        autocomplete="new-password"
                    >
                </div>

                <button type="submit" class="btn btn-primary btn-full" id="resetButton">
                    <span class="btn-text">Réinitialiser le mot de passe</span>
                    <span class="btn-loading" hidden>
                        <span class="spinner"></span> Traitement en cours...
                    </span>
                </button>

                <div id="errorMessage" class="error-message" hidden></div>
                <div id="successMessage" class="success-message" hidden></div>
            </form>

            <div class="login-footer">
                <a href="./login.html">Retour à la connexion</a>
            </div>
        </div>

        <div class="login-info">
            <h2>Créez un nouveau mot de passe</h2>
            <p style="font-size: 16px; line-height: 1.6; opacity: 0.9;">
                Choisissez un mot de passe sécurisé d'au moins 6 caractères.
                Une fois réinitialisé, vous pourrez vous connecter avec vos nouvelles identifiants.
            </p>
        </div>
    </div>

    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Supabase Client -->
    <script src="../js/supabase-client.js"></script>

    <!-- Auth Module -->
    <script src="js/auth.js"></script>

    <!-- Reset Password Script -->
    <script>
        document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            const resetButton = document.getElementById('resetButton');
            const btnText = resetButton.querySelector('.btn-text');
            const btnLoading = resetButton.querySelector('.btn-loading');

            // Hide messages
            errorMessage.hidden = true;
            successMessage.hidden = true;

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                errorMessage.textContent = 'Les mots de passe ne correspondent pas.';
                errorMessage.hidden = false;
                return;
            }

            // Show loading state
            resetButton.disabled = true;
            btnText.hidden = true;
            btnLoading.hidden = false;

            try {
                const supabase = getSupabaseClient();
                if (!supabase) {
                    throw new Error('Client Supabase non initialisé');
                }

                // Update password
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });

                if (error) throw error;

                // Show success message
                successMessage.textContent = 'Mot de passe réinitialisé avec succès! Redirection vers la page de connexion...';
                successMessage.hidden = false;

                // Redirect to login after 2 seconds
                setTimeout(() => {
                    window.location.href = './login.html';
                }, 2000);

            } catch (error) {
                console.error('Reset password error:', error);
                errorMessage.textContent = error.message || 'Erreur lors de la réinitialisation du mot de passe.';
                errorMessage.hidden = false;

                // Reset button state
                resetButton.disabled = false;
                btnText.hidden = false;
                btnLoading.hidden = true;
            }
        });

        // Check if user has a valid recovery session
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const supabase = getSupabaseClient();
                if (!supabase) {
                    throw new Error('Client Supabase non initialisé');
                }

                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) throw error;

                if (!session) {
                    // No valid session, redirect to login
                    const errorMessage = document.getElementById('errorMessage');
                    errorMessage.textContent = 'Lien de réinitialisation invalide ou expiré. Veuillez demander un nouveau lien.';
                    errorMessage.hidden = false;

                    setTimeout(() => {
                        window.location.href = './login.html';
                    }, 3000);
                }
            } catch (error) {
                console.error('Session check error:', error);
            }
        });
    </script>
</body>
</html>
